We attempted to send a web push notification and it failed. I need you to fully debug and implement a production-grade push notification system that works reliably (as close to 100% as web push allows) across modern browsers.

Goal
- Users can opt-in to notifications from the site
- We store subscriptions server-side per user (or per browser session if login does not exist)
- We can send a test push and real pushes from an admin endpoint or UI
- We can verify delivery attempt results and handle failures gracefully

First, do a structured diagnostic of the existing codebase
1) Identify current stack: framework (Next.js, React, Node/Express, etc.), hosting target, whether HTTPS is enabled, and whether we already have a Service Worker
2) Search for any existing push code and list all related files
3) Identify the exact error causing failure (browser console logs, network errors, server logs). Add any missing logging so errors are visible.

Then implement the missing prerequisites and the full push flow

A. Browser-side requirements
- Ensure the app is served over HTTPS in production (push does not work on insecure origins; localhost is an exception)
- Create or fix the Service Worker file at /service-worker.js (or framework-specific location) and ensure it is registered correctly
- Implement the “push” event handler in the Service Worker to display notifications using self.registration.showNotification
- Implement “notificationclick” handler to open or focus the target URL
- Add a clear UI for requesting permission (must be user initiated, do not auto prompt)
- Provide a “Subscribe” button that:
  - Checks Notification.permission
  - Registers the Service Worker successfully
  - Uses PushManager.subscribe with applicationServerKey (VAPID public key)
  - Returns the subscription JSON to the server

B. Server-side requirements
- Use the standard Web Push protocol with VAPID keys
- Generate VAPID keys if missing and store them in environment variables
  - VAPID_PUBLIC_KEY
  - VAPID_PRIVATE_KEY
  - VAPID_SUBJECT (mailto: or https URL)
- Add endpoints
  - POST /api/push/subscribe to store subscription
  - POST /api/push/unsubscribe to remove it
  - POST /api/push/test to send a test push to the current user
  - POST /api/push/broadcast to send to all subscriptions (admin protected)
- Persist subscriptions in a database (SQLite is fine for Replit) with fields:
  - id
  - user_id nullable
  - endpoint unique
  - p256dh
  - auth
  - user_agent
  - created_at
  - last_success_at
  - last_failure_at
  - failure_reason
- Implement cleanup logic: if a send returns 404 or 410, delete that subscription

C. Admin tools and testing
- Add a simple admin page or CLI route that can send a test notification with title, body, url
- Log every send attempt with status and error to a table or log output
- Provide a “diagnostics” page that shows:
  - permission status
  - service worker registered status and scope
  - subscription exists yes/no
  - VAPID public key present yes/no
  - last send result

D. Reliability checklist
- Enforce the required header and payload formatting
- Handle Safari separately:
  - Detect if browser is Safari and explain that standard Web Push support differs by version; if unsupported, show a fallback (email or SMS capture)
- Ensure notifications are only requested after a user gesture
- Ensure the Service Worker file is actually reachable at the expected URL and not blocked by framework routing
- Ensure the push payload includes a url and notification metadata
- Ensure that the app icon and badge are set, and that notification display works even when the site is closed

Deliverables
1) A short explanation of the root cause(s) found for the failure
2) A list of files changed or created
3) Instructions to test locally and in production, including how to confirm HTTPS, SW registration, and a successful push send
4) A “Send Test Push” flow that I can run immediately

Do not stop at theory. Make the changes in code, run/build the project, and show the exact steps and output to confirm it works.
